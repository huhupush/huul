<template>
  <div style="width:100%;height:100%" v-if="aaaa">
    <el-drawer
      title="识别结果"
      :visible.sync="drawer"
      direction="btt"
      :with-header="false"
      :before-close="clo"
      size="400px"
    >
      <el-divider style="margin-top:5px">
        <i class="el-icon-check"></i>
      </el-divider>
      <div class="tag">
        <el-tag closable style="margin:5px;margin-left:20px">{{fin['cate_name']}}</el-tag>
        <el-tag closable style="margin:5px" type="info">{{fin['city_name']}}</el-tag>
        <el-tag closable style="margin:5px" type="success">{{fin['garbage_name']}}</el-tag>
      </div>
      <el-card class="card">
        &nbsp;
      <div class="ps">
        {{fin['ps']}}
      </div>
      </el-card>
    </el-drawer>

    <div class="sv">
      <div class="svgfirr">
        <div class="svgfir">
          <div class="svg">
            <label for="imagefile" class="svgg">
              <svg
                t="1589096136372"
                class="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="8226"
                width="128"
                height="128"
              >
                <path
                  d="M228.072727 427.287273v306.269091c9.309091-0.930909 18.618182-10.24 18.618182-20.48V406.807273c-9.309091 0.930909-18.618182 10.24-18.618182 20.48zM657.221818 392.843636c1.861818 0.930909 4.654545 1.861818 6.516364 2.792728-1.861818-1.861818-3.723636-2.792727-6.516364-2.792728zM665.6 395.636364c2.792727 0.930909 5.585455 2.792727 8.378182 3.723636-2.792727-1.861818-5.585455-2.792727-8.378182-3.723636zM457.076364 558.545455v0zM640.465455 387.258182c1.861818 0 3.723636 0.930909 5.585454 1.861818-1.861818-0.930909-3.723636-0.930909-5.585454-1.861818zM673.978182 399.36c2.792727 0.930909 4.654545 2.792727 7.447273 3.723636-2.792727-0.930909-4.654545-2.792727-7.447273-3.723636zM613.469091 383.534545c1.861818 0 3.723636 0 6.516364 0.93091-2.792727-0.930909-4.654545-0.930909-6.516364-0.93091zM622.778182 384.465455c1.861818 0 3.723636 0.930909 5.585454 0.930909-1.861818-0.930909-3.723636-0.930909-5.585454-0.930909zM648.843636 390.050909c1.861818 0.930909 3.723636 0.930909 5.585455 1.861818-1.861818-0.930909-3.723636-1.861818-5.585455-1.861818zM601.367273 382.603636h9.309091-9.309091zM729.832727 444.043636c-3.723636-4.654545-7.447273-9.309091-12.101818-13.032727 4.654545 3.723636 8.378182 8.378182 12.101818 13.032727zM712.145455 424.494545c1.861818 1.861818 3.723636 3.723636 5.585454 4.654546-2.792727-0.930909-3.723636-2.792727-5.585454-4.654546zM705.629091 418.909091c1.861818 0.930909 3.723636 2.792727 4.654545 3.723636-1.861818-0.930909-3.723636-1.861818-4.654545-3.723636zM683.287273 404.014545c1.861818 0.930909 3.723636 1.861818 5.585454 3.723637-1.861818-0.930909-3.723636-2.792727-5.585454-3.723637zM690.734545 408.669091c1.861818 0.930909 3.723636 1.861818 5.585455 3.723636-1.861818-0.930909-3.723636-1.861818-5.585455-3.723636zM698.181818 414.254545c1.861818 0.930909 3.723636 2.792727 4.654546 3.723637-0.930909-1.861818-2.792727-2.792727-4.654546-3.723637zM632.087273 385.396364c1.861818 0 3.723636 0.930909 5.585454 0.930909-2.792727 0-3.723636-0.930909-5.585454-0.930909zM435.665455 570.647273c0 1.861818 0.930909 3.723636 0.930909 5.585454 0-1.861818 0-3.723636-0.930909-5.585454zM464.523636 644.189091c-0.930909-1.861818-2.792727-3.723636-3.723636-5.585455 0.930909 1.861818 2.792727 3.723636 3.723636 5.585455zM470.109091 651.636364c-0.930909-1.861818-2.792727-3.723636-3.723636-4.654546 0.930909 0.930909 1.861818 2.792727 3.723636 4.654546zM434.734545 561.338182c0 1.861818 0 3.723636 0.93091 6.516363 0-2.792727-0.930909-4.654545-0.93091-6.516363zM475.694545 658.152727c-1.861818-1.861818-2.792727-3.723636-4.654545-4.654545l4.654545 4.654545zM612.538182 405.876364h-1.861818c0-0.930909 0.930909-0.930909 1.861818 0zM434.734545 549.236364v0zM729.832727 444.043636c-28.858182-23.272727-65.163636-37.236364-105.192727-37.236363h-3.723636C690.734545 417.047273 744.727273 476.625455 744.727273 549.236364c0 79.127273-64.232727 144.290909-144.290909 144.290909-72.610909 0-133.12-53.992727-142.429091-123.810909v3.723636c0 40.029091 13.963636 76.334545 37.236363 105.192727-4.654545-3.723636-9.309091-7.447273-13.032727-12.101818 29.789091 30.72 72.610909 49.338182 118.225455 49.338182 92.16 0 166.632727-74.472727 166.632727-166.632727 0.930909-40.029091-13.963636-76.334545-37.236364-105.192728z"
                  fill="#FDBD1D"
                  p-id="8227"
                />
                <path
                  d="M482.210909 665.6c-1.861818-1.861818-3.723636-3.723636-4.654545-5.585455 0.930909 1.861818 2.792727 3.723636 4.654545 5.585455zM451.490909 621.847273c0.930909 2.792727 2.792727 4.654545 3.723636 7.447272-0.930909-2.792727-2.792727-4.654545-3.723636-7.447272zM456.145455 631.156364c0.930909 1.861818 1.861818 3.723636 3.723636 5.585454-1.861818-1.861818-2.792727-3.723636-3.723636-5.585454zM447.767273 613.469091c0.930909 2.792727 2.792727 5.585455 3.723636 8.378182-1.861818-2.792727-2.792727-5.585455-3.723636-8.378182zM444.043636 605.090909c0.930909 1.861818 1.861818 4.654545 2.792728 6.516364-0.930909-1.861818-1.861818-3.723636-2.792728-6.516364zM439.389091 588.334545c0 1.861818 0.930909 3.723636 1.861818 5.585455-0.930909-1.861818-1.861818-3.723636-1.861818-5.585455zM437.527273 579.956364c0 1.861818 0.930909 3.723636 0.930909 5.585454 0-1.861818-0.930909-3.723636-0.930909-5.585454zM441.250909 596.712727c0.930909 1.861818 0.930909 3.723636 1.861818 5.585455 0-1.861818-0.930909-3.723636-1.861818-5.585455z"
                  fill="#FDBD1D"
                  p-id="8228"
                />
                <path
                  d="M710.283636 222.487273c2.792727 0 4.654545 0 7.447273 0.930909-2.792727-0.930909-4.654545-0.930909-7.447273-0.930909zM719.592727 222.487273c1.861818 0 3.723636 0.930909 5.585455 0.930909-1.861818 0-3.723636 0-5.585455-0.930909zM726.109091 224.349091c1.861818 0.930909 4.654545 1.861818 6.516364 1.861818-1.861818 0-4.654545-0.930909-6.516364-1.861818zM751.243636 240.174545c0.930909 1.861818 2.792727 2.792727 3.723637 4.654546-0.930909-0.930909-1.861818-2.792727-3.723637-4.654546zM755.898182 245.76c0.930909 1.861818 2.792727 3.723636 3.723636 5.585455-1.861818-1.861818-2.792727-3.723636-3.723636-5.585455zM750.312727 239.243636c-2.792727-3.723636-6.516364-6.516364-10.24-8.378181 3.723636 2.792727 7.447273 5.585455 10.24 8.378181zM733.556364 227.141818c1.861818 0.930909 3.723636 1.861818 4.654545 2.792727-0.930909-0.930909-2.792727-1.861818-4.654545-2.792727zM159.185455 792.203636c-1.861818-0.930909-3.723636-1.861818-5.585455-3.723636 1.861818 1.861818 3.723636 2.792727 5.585455 3.723636zM140.567273 775.447273c-0.930909-1.861818-2.792727-3.723636-3.723637-4.654546 1.861818 1.861818 2.792727 2.792727 3.723637 4.654546z"
                  fill="#58D2D4"
                  p-id="8229"
                />
                <path
                  d="M831.301818 304.407273H781.963636c-4.654545 0-9.309091-2.792727-12.101818-6.516364-2.792727-3.723636-4.654545-8.378182-3.723636-13.032727 0-2.792727 0.930909-5.585455 0.930909-7.447273 0-9.309091-1.861818-21.410909-6.516364-28.858182-7.447273-3.723636-15.825455-9.309091-25.134545-9.309091H515.723636c-30.72 0-54.923636 27.927273-54.923636 58.647273 0 1.861818 0 6.516364 0.930909 9.309091 0.930909 4.654545-0.930909 13.032727-3.723636 16.756364-2.792727 3.723636-7.447273 9.309091-12.101818 9.309091H216.901818c-36.305455 0-63.301818 24.203636-63.301818 60.50909v367.709091c0 12.101818 1.861818 26.996364 7.447273 37.236364 9.309091 5.585455 18.618182 7.447273 30.72 7.447273l640.465454-4.654546c36.305455 0 66.094545-26.996364 66.094546-63.301818V368.64c0-36.305455-31.650909-64.232727-67.025455-64.232727zM274.618182 713.076364c0 29.789091-24.203636 53.992727-53.992727 53.992727s-47.476364-25.134545-47.476364-54.923636l-0.930909-306.269091c0-29.789091 18.618182-55.854545 48.407273-55.854546s53.992727 24.203636 53.992727 53.992727v309.061819z m326.749091 36.305454c-109.847273 0-200.145455-89.367273-200.145455-200.145454 0-109.847273 89.367273-200.145455 200.145455-200.145455C711.214545 349.090909 800.581818 439.389091 800.581818 549.236364s-89.367273 200.145455-199.214545 200.145454z m218.763636-317.44c-29.789091 0-53.992727-24.203636-53.992727-53.992727s24.203636-53.992727 53.992727-53.992727c29.789091 0 53.992727 24.203636 53.992727 53.992727 0 29.789091-24.203636 53.992727-53.992727 53.992727zM127.534545 736.349091c0 2.792727 0 5.585455 0.93091 8.378182-0.930909-2.792727-0.930909-5.585455-0.93091-8.378182zM141.498182 777.309091c2.792727 3.723636 6.516364 7.447273 11.170909 11.170909l-11.170909-11.170909zM135.912727 768.930909c-2.792727-4.654545-4.654545-9.309091-5.585454-13.963636 0.930909 4.654545 3.723636 9.309091 5.585454 13.963636zM129.396364 752.174545c-0.930909-1.861818-0.930909-3.723636-0.930909-5.585454 0 1.861818 0.930909 3.723636 0.930909 5.585454z"
                  fill="#58D2D4"
                  p-id="8230"
                />
                <path
                  d="M611.607273 438.458182h1.861818-1.861818zM643.258182 446.836364c0.930909 0 0.930909 0.930909 1.861818 0.930909-0.930909-0.930909-0.930909-0.930909-1.861818-0.930909zM633.949091 443.112727zM622.778182 440.32h1.861818-1.861818zM653.498182 451.490909c0.930909 0 0.930909 0.930909 1.861818 0.930909-0.930909-0.930909-1.861818-0.930909-1.861818-0.930909zM686.08 478.487273c0.930909 0.930909 0.930909 0 0 0zM680.494545 471.970909l-1.861818-1.861818 1.861818 1.861818zM662.807273 457.076364s0.930909 0 0 0c0.930909 0 0 0 0 0zM670.254545 462.661818c0.930909 0 0.930909 0.930909 1.861819 0.930909 0 0-0.930909 0-1.861819-0.930909zM509.207273 611.607273s0-0.930909 0 0zM531.549091 635.810909c-0.930909-0.930909-0.930909-0.930909 0 0zM515.723636 619.985455l-1.861818-1.861819 1.861818 1.861819zM522.24 626.501818l1.861818 1.861818c-0.930909 0-1.861818-0.930909-1.861818-1.861818zM689.803636 483.141818c-18.618182-13.032727-40.96-21.410909-65.163636-21.410909-61.44 0-110.778182 49.338182-110.778182 110.778182 0 24.203636 8.378182 47.476364 21.410909 65.163636 18.618182 13.963636 40.96 21.410909 66.094546 21.410909 61.44 0 110.778182-49.338182 110.778182-110.778181 0-24.203636-8.378182-46.545455-22.341819-65.163637zM498.967273 592.989091c0-0.930909-0.930909-0.930909-0.930909-1.861818 0.930909 0.930909 0.930909 0.930909 0.930909 1.861818zM492.450909 572.509091v-1.861818 1.861818zM495.243636 582.749091s0-0.930909 0 0c0-0.930909 0 0 0 0zM504.552727 603.229091c0-0.930909-0.930909-0.930909-0.930909-1.861818 0 0.930909 0 0.930909 0.930909 1.861818zM490.589091 561.338182v-1.861818 1.861818z"
                  fill="#FDBD1D"
                  p-id="8231"
                />
                <path
                  d="M256.930909 267.170909h82.850909v-10.24c-9.309091-2.792727-19.549091-4.654545-30.72-4.654545-26.065455-0.930909-46.545455 5.585455-52.130909 14.894545z"
                  fill="#FDBD1D"
                  p-id="8232"
                />
                <path
                  d="M601.367273 749.381818C711.214545 749.381818 800.581818 659.083636 800.581818 549.236364s-89.367273-200.145455-200.145454-200.145455C490.589091 349.090909 400.290909 438.458182 400.290909 549.236364c0.930909 109.847273 90.298182 200.145455 201.076364 200.145454z m0-366.778182c92.16 0 166.632727 74.472727 166.632727 166.632728s-74.472727 166.632727-166.632727 166.632727-166.632727-74.472727-166.632728-166.632727c0-92.16 74.472727-166.632727 166.632728-166.632728z"
                  fill="#B74B00"
                  p-id="8233"
                />
                <path
                  d="M831.301818 269.963636h-32.581818c-3.723636-45.614545-41.890909-80.989091-87.505455-80.989091H491.52c-46.545455 0-83.781818 35.374545-87.505455 80.989091h-33.512727v-20.48c0-30.72-37.236364-53.992727-85.643636-53.992727s-85.643636 23.272727-85.643637 53.992727V269.963636h-4.654545c-53.992727 0-98.676364 44.683636-98.676364 98.676364v367.709091c0 53.992727 44.683636 98.676364 98.676364 98.676364h637.672727c53.992727 0 98.676364-44.683636 98.676364-98.676364V368.64C929.978182 314.647273 885.294545 269.963636 831.301818 269.963636zM127.534545 368.64c0-36.305455 29.789091-65.163636 65.163637-65.163636h228.072727c4.654545 0 9.309091-1.861818 12.101818-5.585455s4.654545-8.378182 3.723637-13.032727c0-2.792727-0.930909-4.654545-0.930909-7.447273 0-30.72 24.203636-54.923636 54.923636-54.923636h218.763636c30.72 0 54.923636 24.203636 54.923637 54.923636 0 1.861818 0 4.654545-0.930909 7.447273-0.930909 4.654545 0.930909 9.309091 3.723636 13.032727s7.447273 5.585455 12.101818 5.585455H828.509091c36.305455 0 65.163636 29.789091 65.163636 65.163636v367.709091c0 36.305455-29.789091 65.163636-65.163636 65.163636H192.698182c-36.305455 0-65.163636-29.789091-65.163637-65.163636V368.64z m103.33091-119.156364c0-7.447273 20.48-20.48 53.061818-20.48s53.061818 13.032727 53.061818 20.48v19.549091H230.865455v-19.549091z"
                  fill="#B74B00"
                  p-id="8234"
                />
                <path
                  d="M224.349091 767.069091c29.789091 0 53.992727-24.203636 53.992727-53.992727V404.014545c0-29.789091-24.203636-53.992727-53.992727-53.992727s-53.992727 24.203636-53.992727 53.992727v309.061819c0 29.789091 24.203636 53.992727 53.992727 53.992727z m-21.410909-363.054546c0-11.170909 9.309091-21.410909 21.410909-21.410909 11.170909 0 21.410909 9.309091 21.410909 21.410909v309.061819c0 11.170909-9.309091 21.410909-21.410909 21.410909-11.170909 0-21.410909-9.309091-21.410909-21.410909V404.014545zM601.367273 693.527273c79.127273 0 144.290909-64.232727 144.290909-144.290909 0-79.127273-64.232727-144.290909-144.290909-144.290909-79.127273 0-144.290909 64.232727-144.290909 144.290909 0 79.127273 64.232727 144.290909 144.290909 144.290909z m0-255.069091c61.44 0 110.778182 49.338182 110.778182 110.778182s-49.338182 110.778182-110.778182 110.778181S490.589091 610.676364 490.589091 549.236364c-0.930909-61.44 49.338182-110.778182 110.778182-110.778182zM820.130909 431.941818c29.789091 0 53.992727-24.203636 53.992727-53.992727s-24.203636-53.992727-53.992727-53.992727-53.992727 24.203636-53.992727 53.992727c0 29.789091 24.203636 53.992727 53.992727 53.992727z m0-74.472727c11.170909 0 20.48 9.309091 20.48 20.48s-9.309091 20.48-20.48 20.48-20.48-9.309091-20.48-20.48 9.309091-20.48 20.48-20.48z"
                  fill="#B74B00"
                  p-id="8235"
                />
              </svg>
            </label>
          </div>
        </div>
      </div>
      <div class="city">
        <!-- 选择城市编码 -->
        <el-select v-model="value" placeholder="请选择" size="small" class="cith">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          ></el-option>
        </el-select>
      </div>
      <input
        type="file"
        accept="image/*"
        @change="takePhoto($event)"
        name="img"
        
        id="imagefile"
      />
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      fin: {},
      aaaa:true,
      drawer: false,
      urlaa: '1',
      appkey: 'e76ade99287e405849bb19e275472e21',
      setkey: '8060269e25d3d63b782eed45e9d07294',
      body: {
        cityId: '110000',
        imgBase64: ''
      },
      options: [
        {
          value: '310000',
          label: '上海市'
        },
        {
          value: '330200',
          label: '宁波市'
        },
        {
          value: '440300',
          label: '深圳市'
        },
        {
          value: '610100',
          label: '西安市'
        },
        {
          value: '110000',
          label: '北京市'
        }
      ],
      value: '110000'
    }
  },
  mounted() {},
  methods: {
    clo(){
      Object.assign(this.$data, this.$options.data())
      this.drawer = false
      setTimeout(() => {
        this.aaaa = false
        this.$nextTick(function(){
          this.aaaa = true
        })
      }, 100);
    },
    bbb() {
      console.log(this.urlaa)
    },
    bb(base64) {
      this.urlaa = base64
      // console.log(base64.indexOf(','))
      var a = base64.slice(base64.indexOf(',') + 1)
      var timestamp = new Date().getTime()
      String(timestamp)
      var sig = this.setkey + timestamp
      sig = md5(sig)
      // console.log(sig)
      var url =
        '/jda' +
        '?' +
        'appkey=' +
        this.appkey +
        '&' +
        'timestamp=' +
        timestamp +
        '&' +
        'sign=' +
        sig
      this.body.imgBase64 = a
      // console.log(this.body)
      var aa = JSON.stringify(this.body)
      // console.log(url)
      this.axios
        .post(url, aa, {
          headers: { 'Content-Type': 'application/json;charset=UTF-8' }
        })
        .then(res => {
          // console.log(res.data)
          this.finish(res.data)
        })
      // this.body.imgBase64 = b
      // alert(base64)
    },
    finish(e) {
      console.log(e);
      var result = e['result']['garbage_info'];
      var confi = 0;
      var index = 0;
      var i;
      for (i in result) {
        if (result[i]['confidence'] > confi) {
          confi = result[i]['confidence']
          index = i
        }
      }
      // console.log(result[index])
      this.fin = result[index]
      setTimeout(() => {
        this.drawer = true
      }, 50)
    },
    takePhoto(e) {
      //拍照功能---上传头像
      var file = e.target.files[0] //获取文件对象
      // alert(file)
      var imgfile = new FileReader()
      imgfile.readAsDataURL(file)
      
      var that = this
      imgfile.onload = function() {
        var imgdata = this.result
        // console.log(that.urlaa)
        that.urlaa = imgdata
        // console.log(that.urlaa)
        // console.log(that.urlaa)
        // var that =this
        // that.data.urlaa = imgdata
        // console.log(this.urlaa)
      }
      setTimeout(() => {
        // console.log(this.urlaa)
        // alert(this.urlaa)
        this.dealImage(this.urlaa, 800, this.bb)
      },265)
      // that.dealImage(that.urla, 800);
    },
    dealImage(base64, w, callback) {
      var newImage = new Image()
      var quality = 0.8 //压缩系数0-1之间
      newImage.src = base64
      newImage.setAttribute('crossOrigin', 'Anonymous') //url为外域时需要
      var imgWidth, imgHeight
      var that = this
      newImage.onload = function() {
        imgWidth = this.width
        imgHeight = this.height
        var canvas = document.createElement('canvas')
        var ctx = canvas.getContext('2d')
        if (Math.max(imgWidth, imgHeight) > w) {
          if (imgWidth > imgHeight) {
            canvas.width = w
            canvas.height = (w * imgHeight) / imgWidth
          } else {
            canvas.height = w
            canvas.width = (w * imgWidth) / imgHeight
          }
        } else {
          canvas.width = imgWidth
          canvas.height = imgHeight
          quality = 0.8
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        ctx.drawImage(this, 0, 0, canvas.width, canvas.height)
        // 如想确保图片压缩到自己想要的尺寸,如要求在50-150kb之间，请加以下语句，quality初始值根据情况自定
        var hh = base64.length/1024
        console.log(hh)
        while (hh > 2048) {
          quality -= 0.1
          base64 = canvas.toDataURL('image/jpeg', quality)
          hh = base64.length/1024
          // console.log(hh)
        }
        // 防止最后一次压缩低于最低尺寸，只要quality递减合理，无需考虑
        // while (base64.length / 1024 < 50) {
        // 	quality += 0.001;
        // 	base64 = canvas.toDataURL("image/jpeg", quality);
        // }
        //必须通过回调函数返回，否则无法及时拿到该值
      }
      setTimeout(() => {
        callback(base64)
      }, 100)
    }
  }
}
</script>

<style>
.card{
  width: 90%;
  margin-left: 20px;
  margin-top: 20px;
  font-size: 17px;
  font: 14px/1.5 'Microsoft YaHei',arial,tahoma,\5b8b\4f53,sans-serif;
}
.tag{
  
  display: flex;

}
#imagefile {
  display: none;
}
.sv {
  width: 100%;
  height: 100%;
  overflow: hidden;

  background-color: rgba(250, 235, 215, 0.493);
}

.svg {
  width: 100%;

  margin: 0 auto;
  padding: 0 auto;
  position: relative;
}
.svgg {
  margin: 0 auto;
  height: 600px;
  width: 400px;
}
.svgfir {
  width: 128px;
  height: 128px;
  margin: 0 auto;
}
.svgfir {
  margin-top: 135px;
  display: flex;
  justify-content: center;
}
.el-select {
  margin: 0 auto;
}
.city {
  display: flex;
  justify-content: center;
}
</style>
